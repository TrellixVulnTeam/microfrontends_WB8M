const a5_0x5202=['completedStatusCode','retryDuring','.lock','printRunGroupError','getTime','CIRCLE_STAGE','writeFileSync','exit','/lockfiles','configuration','projectName','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','length','createNoNewMessagesTimeout','executionId:\x20','executionId','env','message','find','assign','defineProperty','readFileSync','target','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','SIGINT','tasks','API\x20Response','Other\x20Nx\x20Cloud\x20Agents\x20Detected','../../../utilities/waiter','criticalErrorMessage','join','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','cacheDirectory','../../../utilities/create-no-new-messages-timeout','\x20--projects=','number\x20of\x20tasks:\x20','Fetching\x20tasks...','then','Executing:\x20\x27','Duplicate\x20Agent\x20ID\x20Detected','completedTasks','./node_modules/.cache/nx','floor','push','throw','next','../../../utilities/environment','Distributed\x20Execution\x20Terminated','Waiting...','reset','Critical\x20Error\x20in\x20Agent:\x20\x22','apply','Waiter','parse','maxParallel:\x20','CIRCLECI','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks',').\x20Tasks\x20hashes\x20haven\x27t\x20been\x20recorded.','maxParallel','strip-json-comments','submitRunMetrics','wait','random','unlinkSync','toString','DistributedAgentApi','NX_AGENT_NAME','taskId','execSync','value','includes','../../../utilities/nx-imports','existsSync','completed','options','Command\x20execution\x20failed\x20(distributed\x20task\x20execution:\x20','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','VERBOSE_LOGGING','error:\x20','__awaiter','inherit','status','npx\x20nx\x20run-many\x20--target=','default','DISTRIBUTED_TASK_EXECUTION_INTERNAL_ERROR_STATUS_CODE','startAgent','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','./distributed-agent.api','note','../../../utilities/metric-logger','../../error/print-run-group-error','readdirSync'];(function(_0x252203,_0x520227){const _0x15be98=function(_0x6a5fac){while(--_0x6a5fac){_0x252203['push'](_0x252203['shift']());}};_0x15be98(++_0x520227);}(a5_0x5202,0x6d));const a5_0x15be=function(_0x252203,_0x520227){_0x252203=_0x252203-0x0;let _0x15be98=a5_0x5202[_0x252203];return _0x15be98;};'use strict';var __awaiter=this&&this[a5_0x15be('0x3e')]||function(_0x1b60fd,_0x38dafe,_0x57cf10,_0x5b0e9e){function _0x3171df(_0x325d17){return _0x325d17 instanceof _0x57cf10?_0x325d17:new _0x57cf10(function(_0x17298d){_0x17298d(_0x325d17);});}return new(_0x57cf10||(_0x57cf10=Promise))(function(_0x22ba97,_0x3b1938){function _0x32a479(_0x453a77){try{_0x1011e7(_0x5b0e9e['next'](_0x453a77));}catch(_0x3c7674){_0x3b1938(_0x3c7674);}}function _0x29d7ea(_0x5d0dcf){try{_0x1011e7(_0x5b0e9e[a5_0x15be('0x1b')](_0x5d0dcf));}catch(_0x519576){_0x3b1938(_0x519576);}}function _0x1011e7(_0x598c64){_0x598c64['done']?_0x22ba97(_0x598c64[a5_0x15be('0x34')]):_0x3171df(_0x598c64[a5_0x15be('0x34')])[a5_0x15be('0x14')](_0x32a479,_0x29d7ea);}_0x1011e7((_0x5b0e9e=_0x5b0e9e[a5_0x15be('0x22')](_0x1b60fd,_0x38dafe||[]))[a5_0x15be('0x1c')]());});};Object[a5_0x15be('0x3')](exports,'__esModule',{'value':!![]});exports['startAgent']=void 0x0;const child_process_1=require('child_process');const stripJsonComments=require(a5_0x15be('0x2a'));const distributed_agent_api_1=require(a5_0x15be('0x46'));const waiter_1=require(a5_0x15be('0xb'));const environment_1=require(a5_0x15be('0x1d'));const print_run_group_error_1=require(a5_0x15be('0x49'));const create_no_new_messages_timeout_1=require(a5_0x15be('0x10'));const fs_1=require('fs');const metric_logger_1=require(a5_0x15be('0x48'));const {output,workspaceRoot}=require(a5_0x15be('0x36'));function executeTasks(_0x4897a8,_0x2f2282){return __awaiter(this,void 0x0,void 0x0,function*(){let _0x3c7d2f=0x0;let _0x1db7e1=null;const _0x5b8b03=(0x0,create_no_new_messages_timeout_1[a5_0x15be('0x58')])();const _0x234d32=new waiter_1[(a5_0x15be('0x23'))]();let _0x2c07ab=[];const _0x5727a3=new Date();let _0x4198ca=![];while(!![]){if(environment_1[a5_0x15be('0x3c')]){output['note']({'title':a5_0x15be('0x13')});}_0x1db7e1=yield _0x2f2282[a5_0x15be('0x8')](_0x1db7e1?_0x1db7e1[a5_0x15be('0x5a')]:null,_0x3c7d2f,_0x2c07ab);if(environment_1[a5_0x15be('0x3c')]){output['note']({'title':a5_0x15be('0x9'),'bodyLines':['completed:\x20'+_0x1db7e1['completed'],'retryDuring:\x20'+_0x1db7e1[a5_0x15be('0x4c')],a5_0x15be('0x59')+_0x1db7e1[a5_0x15be('0x5a')],a5_0x15be('0x12')+_0x1db7e1['tasks'][a5_0x15be('0x57')],a5_0x15be('0x3d')+_0x1db7e1['criticalErrorMessage'],a5_0x15be('0x25')+_0x1db7e1[a5_0x15be('0x29')]]});}if(_0x1db7e1[a5_0x15be('0xc')]){output['error']({'title':a5_0x15be('0x1e'),'bodyLines':['Error:',_0x1db7e1['criticalErrorMessage']]});process[a5_0x15be('0x52')](0x0);}if((_0x1db7e1===null||_0x1db7e1===void 0x0?void 0x0:_0x1db7e1['retryDuring'])&&(_0x1db7e1===null||_0x1db7e1===void 0x0?void 0x0:_0x1db7e1[a5_0x15be('0x4c')])!==0x0&&!_0x4198ca&&new Date()[a5_0x15be('0x4f')]()-_0x5727a3[a5_0x15be('0x4f')]()>_0x1db7e1[a5_0x15be('0x4c')]){yield _0x234d32[a5_0x15be('0x2c')]();continue;}if(_0x1db7e1[a5_0x15be('0x38')])return;_0x5b8b03(_0x1db7e1[a5_0x15be('0x8')]['map'](_0x51c3c7=>_0x51c3c7[a5_0x15be('0x32')])[a5_0x15be('0xd')](''));if(!_0x1db7e1[a5_0x15be('0x5a')]){if(environment_1[a5_0x15be('0x3c')]){output[a5_0x15be('0x47')]({'title':a5_0x15be('0x1f')});}yield _0x234d32[a5_0x15be('0x2c')]();_0x3c7d2f=0x0;_0x2c07ab=[];continue;}_0x234d32[a5_0x15be('0x20')]();_0x4198ca=!![];const _0x165b8d=invokeTasksUsingRunMany(_0x4897a8,_0x1db7e1[a5_0x15be('0x5a')],_0x1db7e1[a5_0x15be('0x8')],_0x1db7e1[a5_0x15be('0x29')]);_0x3c7d2f=_0x165b8d[a5_0x15be('0x4b')];_0x2c07ab=_0x165b8d[a5_0x15be('0x17')];}});}function readCompletedTasks(_0x245e17,_0x270559){const _0x49907c=a5_0x15be('0x3a')+_0x270559+a5_0x15be('0x28');let _0x1c662a;try{const _0x449482=_0x245e17[a5_0x15be('0xf')]||'./node_modules/.cache/nx';const _0x19cc6c=_0x449482+'/tasks-hashes-'+_0x270559;_0x1c662a=JSON[a5_0x15be('0x24')]((0x0,fs_1[a5_0x15be('0x4')])(_0x19cc6c)[a5_0x15be('0x2f')]());(0x0,fs_1[a5_0x15be('0x2e')])(_0x19cc6c);}catch(_0x45bb79){throw new Error(_0x49907c);}if(_0x1c662a[a5_0x15be('0x57')]==0x0){throw new Error(_0x49907c);}return _0x1c662a;}function invokeTasksUsingRunMany(_0x24b288,_0x4358a2,_0x420c44,_0x1f7384){let _0x5a2dbd=0x0;const _0x4f3aed=[];for(const _0x4ea7fd of groupByTarget(_0x420c44)){const _0x35ca3f=_0x4ea7fd['configuration']?'--configuration='+_0x4ea7fd[a5_0x15be('0x54')]:'';const _0x23c99d=_0x1f7384>0x1?'\x20--parallel\x20--max-parallel='+_0x1f7384:'';const _0x15b773=a5_0x15be('0x41')+_0x4ea7fd['target']+'\x20'+_0x35ca3f+a5_0x15be('0x11')+_0x4ea7fd['projects'][a5_0x15be('0xd')](',')+'\x20'+_0x4ea7fd['params']+_0x23c99d;if(environment_1[a5_0x15be('0x3c')]){output['note']({'title':a5_0x15be('0x15')+_0x15b773+'\x27'});}try{(0x0,child_process_1[a5_0x15be('0x33')])(_0x15b773,{'stdio':[a5_0x15be('0x3f'),a5_0x15be('0x3f'),a5_0x15be('0x3f')],'env':Object[a5_0x15be('0x2')](Object[a5_0x15be('0x2')]({},process['env']),{'NX_CACHE_FAILURES':'true','NX_CLOUD_DISTRIBUTED_EXECUTION_ID':_0x4358a2})});}catch(_0x5bbd85){if(_0x5bbd85[a5_0x15be('0x40')]===environment_1[a5_0x15be('0x43')]){throw _0x5bbd85;}else{_0x5a2dbd=0x1;}}finally{_0x4f3aed[a5_0x15be('0x1a')](...readCompletedTasks(_0x24b288,_0x4358a2));}}return{'completedStatusCode':_0x5a2dbd,'completedTasks':_0x4f3aed};}function groupByTarget(_0xb09056){const _0x41e176=[];_0xb09056['forEach'](_0xd9c972=>{const _0x2bf547=_0x41e176[a5_0x15be('0x1')](_0x2a5ee1=>_0x2a5ee1[a5_0x15be('0x5')]===_0xd9c972[a5_0x15be('0x5')]&&_0x2a5ee1[a5_0x15be('0x54')]===_0xd9c972['configuration']);if(_0x2bf547){_0x2bf547['projects'][a5_0x15be('0x1a')](_0xd9c972['projectName']);}else{_0x41e176[a5_0x15be('0x1a')]({'target':_0xd9c972[a5_0x15be('0x5')],'projects':[_0xd9c972[a5_0x15be('0x55')]],'params':_0xd9c972['params'],'configuration':_0xd9c972[a5_0x15be('0x54')]});}});return _0x41e176;}function getAgentName(){if(process['env']['NX_AGENT_NAME']!==undefined){return process[a5_0x15be('0x5b')][a5_0x15be('0x31')];}else if(process[a5_0x15be('0x5b')][a5_0x15be('0x26')]!==undefined){return process[a5_0x15be('0x5b')][a5_0x15be('0x50')];}else{return'Agent\x20'+Math[a5_0x15be('0x19')](Math[a5_0x15be('0x2d')]()*0x186a0);}}function createAgentLockfile(_0x320a13,_0x358d39){const _0x1ca6ef=_0x320a13[a5_0x15be('0xf')]||a5_0x15be('0x18');const _0x429354=_0x1ca6ef+a5_0x15be('0x53');const _0x741097=_0x429354+'/'+_0x358d39+a5_0x15be('0x4d');if(!(0x0,fs_1[a5_0x15be('0x37')])(_0x429354)){(0x0,fs_1['mkdirSync'])(_0x429354,{'recursive':!![]});}const _0x31d20c=(0x0,fs_1[a5_0x15be('0x4a')])(_0x429354);if(_0x31d20c['length']){if(_0x31d20c[a5_0x15be('0x35')](_0x358d39+a5_0x15be('0x4d'))){output['error']({'title':a5_0x15be('0x16'),'bodyLines':[a5_0x15be('0x3b'),'',a5_0x15be('0x45')]});process[a5_0x15be('0x52')](0x1);}output['warn']({'title':a5_0x15be('0xa'),'bodyLines':[a5_0x15be('0x6'),'',a5_0x15be('0x56'),a5_0x15be('0xe')]});}(0x0,fs_1[a5_0x15be('0x51')])(_0x741097,'');process['on'](a5_0x15be('0x52'),_0x542885=>cleanupAgentLockfile(_0x741097,_0x542885));process['on'](a5_0x15be('0x7'),()=>cleanupAgentLockfile(_0x741097,0x0));}function cleanupAgentLockfile(_0x350b7a,_0x42559b){if((0x0,fs_1[a5_0x15be('0x37')])(_0x350b7a)){(0x0,fs_1[a5_0x15be('0x2e')])(_0x350b7a);process['exit'](_0x42559b);}}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x4b72f8=(0x0,environment_1['getRunGroup'])();if(!_0x4b72f8){(0x0,print_run_group_error_1[a5_0x15be('0x4e')])();return process[a5_0x15be('0x52')](0x1);}output['note']({'title':a5_0x15be('0x27')});const _0x1a7c7b=JSON[a5_0x15be('0x24')](stripJsonComments((0x0,fs_1[a5_0x15be('0x4')])(workspaceRoot+'/nx.json')['toString']()))['tasksRunnerOptions'][a5_0x15be('0x42')][a5_0x15be('0x39')];const _0x43cbb4=getAgentName();createAgentLockfile(_0x1a7c7b,_0x43cbb4);const _0x405c8e=new distributed_agent_api_1[(a5_0x15be('0x30'))](_0x1a7c7b,_0x4b72f8,_0x43cbb4);return executeTasks(_0x1a7c7b,_0x405c8e)[a5_0x15be('0x14')](_0x28ae35=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a5_0x15be('0x2b')])(_0x1a7c7b);return _0x28ae35;}))['catch'](_0x553358=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x405c8e['completeRunGroupWithError'](a5_0x15be('0x21')+_0x553358[a5_0x15be('0x0')]+'\x22');throw _0x553358;}));});}exports[a5_0x15be('0x44')]=startAgent;